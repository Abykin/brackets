define(function(require,exports,module){"use strict";var AppInit=brackets.getModule("utils/AppInit"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),UrlParams=brackets.getModule("utils/UrlParams").UrlParams,HealthDataUtils=require("HealthDataUtils"),uuid=require("thirdparty/uuid");var prefs=PreferencesManager.getExtensionPrefs("healthData");prefs.definePreference("healthDataTracking","boolean",true);var ONE_DAY=24*60*60*1e3,timeoutVar;var params=new UrlParams;params.parse();function getHealthData(){var result=new $.Deferred,oneTimeHealthData={};var userUuid=PreferencesManager.getViewState("UUID");if(!userUuid){userUuid=uuid.v4();PreferencesManager.setViewState("UUID",userUuid)}oneTimeHealthData.uuid=userUuid;oneTimeHealthData.snapshotTime=Date.now();oneTimeHealthData.os=brackets.platform;oneTimeHealthData.userAgent=navigator.userAgent;oneTimeHealthData.osLanguage=brackets.app.language;oneTimeHealthData.bracketsLanguage=brackets.getLocale();oneTimeHealthData.bracketsVersion=brackets.metadata.version;HealthDataUtils.getUserInstalledExtensions().done(function(userInstalledExtensions){oneTimeHealthData.installedExtensions=userInstalledExtensions}).always(function(){return result.resolve(oneTimeHealthData)});return result.promise()}function sendHealthDataToServer(){var result=new $.Deferred;getHealthData().done(function(healthData){var url=brackets.config.healthDataServerURL,data=JSON.stringify(healthData);$.ajax({url:url,type:"POST",data:data,dataType:"text",contentType:"text/plain"}).done(function(){result.resolve()}).fail(function(jqXHR,status,errorThrown){console.error("Error in sending Health Data. Response : "+jqXHR.responseText+". Status : "+status+". Error : "+errorThrown);result.reject()})}).fail(function(){result.reject()});return result.promise()}function checkHealthDataSend(){var result=new $.Deferred,isHDTracking=prefs.get("healthDataTracking"),notificationDialogShown=PreferencesManager.getViewState("healthDataNotificationShown");window.clearTimeout(timeoutVar);if(isHDTracking&&notificationDialogShown){var lastTimeSent=PreferencesManager.getViewState("lastTimeSentHealthData"),currentTime=Date.now();if(!lastTimeSent||currentTime>=lastTimeSent+ONE_DAY){PreferencesManager.setViewState("lastTimeSentHealthData",Date.now());sendHealthDataToServer().done(function(){result.resolve()}).fail(function(){result.reject()}).always(function(){timeoutVar=setTimeout(checkHealthDataSend,ONE_DAY)})}else{timeoutVar=setTimeout(checkHealthDataSend,lastTimeSent+ONE_DAY-currentTime)}}else{result.reject()}return result.promise()}prefs.on("change","healthDataTracking",function(){checkHealthDataSend()});window.addEventListener("online",function(){checkHealthDataSend()});window.addEventListener("offline",function(){window.clearTimeout(timeoutVar)});AppInit.appReady(function(){checkHealthDataSend()});exports.getHealthData=getHealthData;exports.checkHealthDataSend=checkHealthDataSend});